@page "/bookings/add"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using ServiceBookingPlatform.Models.Dtos.Booking
@using ServiceBookingPlatform.Models.Dtos.Service
@using WasmClient.Api
@inject IUserBookingApiClient BookingClient
@inject IUserServiceApiClient ServiceClient
@inject NavigationManager Navigation

<PageTitle>Add New Booking - Service Booking Platform</PageTitle>

<div class="page-content">
    <div class="container">
        <div class="page-header">
            <h3>
                <i class="bi bi-plus-circle me-2"></i>
                Create New Booking
            </h3>
            <p class="text-muted mb-0">Schedule a new service appointment</p>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading form...</p>
                </div>
            </div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-check me-2"></i>
                                Booking Details
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    @errorMessage
                                    <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(successMessage))
                            {
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    @successMessage
                                    <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
                                </div>
                            }

                            <EditForm Model="@formModel" OnValidSubmit="@HandleSubmit">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="alert alert-warning" />

                                <div class="mb-3">
                                    <label for="service" class="form-label">
                                        <i class="bi bi-briefcase me-1"></i>
                                        Service *
                                    </label>
                                    <InputSelect id="service" class="form-select" @bind-Value="formModel.ServiceId">
                                        <option value="0">-- Select a Service --</option>
                                        @if (services != null)
                                        {
                                            @foreach (var service in services)
                                            {
                                                <option value="@service.Id">@service.ServiceName - @service.ServiceType</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => formModel.ServiceId)" />
                                </div>

                                <div class="mb-3">
                                    <label for="scheduledStart" class="form-label">
                                        <i class="bi bi-calendar-event me-1"></i>
                                        Start Date & Time *
                                    </label>
                                    <InputDate Type="InputDateType.DateTimeLocal" id="scheduledStart" class="form-control" @bind-Value="formModel.ScheduledStart" />
                                    <ValidationMessage For="@(() => formModel.ScheduledStart)" />
                                    <small class="form-text text-muted">When should the service begin?</small>
                                </div>

                                <div class="mb-3">
                                    <label for="scheduledEnd" class="form-label">
                                        <i class="bi bi-calendar-event-fill me-1"></i>
                                        End Date & Time *
                                    </label>
                                    <InputDate Type="InputDateType.DateTimeLocal" id="scheduledEnd" class="form-control" @bind-Value="formModel.ScheduledEnd" />
                                    <ValidationMessage For="@(() => formModel.ScheduledEnd)" />
                                    <small class="form-text text-muted">When should the service end?</small>
                                </div>

                                <div class="mb-4">
                                    <label for="status" class="form-label">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Status *
                                    </label>
                                    <InputSelect id="status" class="form-select" @bind-Value="formModel.Status">
                                        <option value="">-- Select Status --</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="Completed">Completed</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => formModel.Status)" />
                                </div>

                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill me-2"></i>
                                    <strong>Note:</strong> Make sure the end time is after the start time.
                                </div>

                                <hr class="my-4" />

                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                                        <i class="bi bi-x-circle me-2"></i>
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                                        @if (isSubmitting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            <span>Creating...</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-check-circle me-2"></i>
                                            <span>Create Booking</span>
                                        }
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private BookingFormModel formModel = new BookingFormModel
    {
        ServiceId = 0,
        ScheduledStart = DateTime.Now.AddDays(1),
        ScheduledEnd = DateTime.Now.AddDays(1).AddHours(1),
        Status = "Pending"
    };

    private List<ServiceDto>? services;
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading = true;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadServices();
    }

    private async Task LoadServices()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            services = await ServiceClient.GetAllServicesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load services. Please try again.";
            Console.WriteLine($"Error loading services: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // Validate that end time is after start time
            if (formModel.ScheduledEnd <= formModel.ScheduledStart)
            {
                errorMessage = "End time must be after start time.";
                isSubmitting = false;
                return;
            }

            // Validate that service is selected
            if (formModel.ServiceId == 0)
            {
                errorMessage = "Please select a service.";
                isSubmitting = false;
                return;
            }

            // Create the DTO from form model
            var createBookingDto = new CreateBookingDto
            {
                ServiceId = formModel.ServiceId,
                ScheduledStart = formModel.ScheduledStart,
                ScheduledEnd = formModel.ScheduledEnd,
                Status = formModel.Status
            };

            var result = await BookingClient.CreateBookingAsync(createBookingDto);
            
            if (result != null)
            {
                successMessage = "Booking created successfully!";
                
                // Wait a moment to show success message, then navigate to bookings page
                await Task.Delay(1500);
                Navigation.NavigateTo("/bookings");
            }
            else
            {
                errorMessage = "Failed to create booking. Please try again.";
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Network error occurred. Please check your connection and try again.";
            Console.WriteLine($"Error creating booking: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = "An unexpected error occurred. Please try again.";
            Console.WriteLine($"Error creating booking: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/bookings");
    }

    // Mutable form model for data binding
    private class BookingFormModel
    {
        [Required(ErrorMessage = "Booking must be associated with a service.")]
        public int ServiceId { get; set; }

        [Required(ErrorMessage = "Booking must have a scheduled start time.")]
        public DateTime ScheduledStart { get; set; }

        [Required(ErrorMessage = "Booking must have a scheduled end time.")]
        public DateTime ScheduledEnd { get; set; }

        [Required(ErrorMessage = "Booking status is required.")]
        public string Status { get; set; } = string.Empty;
    }
}
